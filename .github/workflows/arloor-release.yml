name: Shadowsocks Build and Release
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
permissions:
  contents: write
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    strategy:
      matrix:
        binary:
          - name: sslocal
            args: --bin sslocal --features https-tunnel
          - name: ssserver
            args: --bin ssserver
    steps:
      - uses: actions/checkout@v4

      # 构建二进制文件
      - name: Build ${{ matrix.binary.name }}
        id: build
        uses: arloor/rust_musl_action@latest
        with:
          use_musl: false
          args: ${{ matrix.binary.args }}
          apt_mirror: mirrors.mit.edu
          extra_deps: gcc
          debug: false

      # 上传二进制文件到 artifact
      - name: Upload ${{ matrix.binary.name }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary.name }}
          path: ${{ steps.build.outputs.release_dir }}${{ matrix.binary.name }}
          retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      # 下载所有构建的二进制文件
      - name: Download sslocal artifact
        uses: actions/download-artifact@v4
        with:
          name: sslocal
          path: release_binaries

      - name: Download ssserver artifact
        uses: actions/download-artifact@v4
        with:
          name: ssserver
          path: release_binaries

      # 查看下载的文件
      - name: List binaries
        run: |
          ls -lh release_binaries/
          chmod +x release_binaries/*

      # 创建 GitHub Release
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version=latest
          if $(gh release delete ${version} -y --cleanup-tag);
            then echo "delete old release";
            else echo "no old release";
          fi
          git config --local user.email "admin@arloor.com"
          git config --local user.name "arloor"
          gh release create ${version} release_binaries/* -n "Shadowsocks 最新构建，包含 sslocal 和 ssserver" --latest -t "${version}"
